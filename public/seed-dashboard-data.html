<!DOCTYPE html>
<html>
<head>
  <title>Seed Dashboard Data - ChatNIL</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 4px solid #4CAF50;
    }
    .section h2 {
      margin-top: 0;
      color: #333;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 4px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .step {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border-radius: 4px;
      border-left: 3px solid #2196F3;
    }
    .step-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    .step-desc {
      color: #666;
      font-size: 14px;
    }
    .warning {
      background: #fff3cd;
      border-left-color: #ffc107;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      border-left: 4px solid #ffc107;
    }
    .success {
      color: #4CAF50;
      font-weight: bold;
    }
    .error {
      color: #f44336;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üå± Seed Dashboard Data</h1>
    <p class="subtitle">Populate test accounts with realistic NIL deals, chats, and metrics</p>

    <div class="warning">
      <strong>‚ö†Ô∏è Important:</strong> This will create test data for all test accounts in your database.
      Make sure you have created test accounts before running this script.
    </div>

    <div class="section">
      <h2>What This Will Create:</h2>
      <div class="step">
        <div class="step-title">üìä NIL Deals</div>
        <div class="step-desc">Active, pending, and completed deals from Nike, local businesses, and brands</div>
      </div>
      <div class="step">
        <div class="step-title">üíº Opportunities</div>
        <div class="step-desc">Open opportunities matching athlete profiles and interests</div>
      </div>
      <div class="step">
        <div class="step-title">üí¨ Chat History</div>
        <div class="step-desc">Conversations about compliance, contracts, and taxes with the AI assistant</div>
      </div>
      <div class="step">
        <div class="step-title">üîî Notifications</div>
        <div class="step-desc">Deal updates, opportunities, and compliance reminders</div>
      </div>
      <div class="step">
        <div class="step-title">üìÖ Events</div>
        <div class="step-desc">Workshops, networking events, and consultation appointments</div>
      </div>
      <div class="step">
        <div class="step-title">üéì Learning Progress</div>
        <div class="step-desc">Quiz completions, badges, and knowledge level tracking</div>
      </div>
      <div class="step">
        <div class="step-title">üìà Metrics</div>
        <div class="step-desc">Profile views, response rates, and performance analytics</div>
      </div>
    </div>

    <div class="section">
      <h2>Steps to Run:</h2>
      <ol>
        <li>Click "Run Migrations" to create necessary database tables</li>
        <li>Click "Seed Data" to populate test accounts with realistic data</li>
        <li>Visit <code>/dashboard</code> to see the results!</li>
      </ol>
    </div>

    <button id="runMigrationsBtn" onclick="runMigrations()">
      1Ô∏è‚É£ Run Migrations
    </button>
    <button id="seedDataBtn" onclick="seedData()" disabled>
      2Ô∏è‚É£ Seed Data
    </button>
    <button onclick="clearOutput()">Clear Output</button>

    <div id="output"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://enbuwffusjhpcyoveewb.supabase.co';
    const SUPABASE_SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuYnV3ZmZ1c2pocGN5b3ZlZXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODY4NjcwOSwiZXhwIjoyMDc0MjYyNzA5fQ.fXvyvHrUoNLdAr1expbRsguM8fkmurrNQi3-7xk8-TM';

    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

    window.log = function(message, type = 'info') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      let className = '';

      if (type === 'success') className = 'success';
      if (type === 'error') className = 'error';

      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    };

    window.clearOutput = function() {
      document.getElementById('output').innerHTML = '';
    };

    window.runMigrations = async function() {
      const btn = document.getElementById('runMigrationsBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Running Migrations...';

      log('üöÄ Starting database migrations...');

      try {
        // Migration 051: Dashboard support tables
        log('\nüìã Running Migration 051: Dashboard support tables...');

        const migration051 = `
-- Notifications table
CREATE TABLE IF NOT EXISTS notifications (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('deal_update', 'opportunity', 'compliance', 'message', 'system')),
  title TEXT NOT NULL,
  message TEXT NOT NULL,
  read BOOLEAN DEFAULT FALSE,
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high')),
  link_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  read_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_notifications_user_id ON notifications(user_id);
CREATE INDEX IF NOT EXISTS idx_notifications_read ON notifications(read);
CREATE INDEX IF NOT EXISTS idx_notifications_created_at ON notifications(created_at DESC);

-- Events table
CREATE TABLE IF NOT EXISTS events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  date TIMESTAMPTZ NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('workshop', 'networking', 'consultation', 'deadline', 'meeting')),
  location TEXT,
  link_url TEXT,
  reminder_sent BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_events_user_id ON events(user_id);
CREATE INDEX IF NOT EXISTS idx_events_date ON events(date);
CREATE INDEX IF NOT EXISTS idx_events_type ON events(type);

-- Quiz Progress table
CREATE TABLE IF NOT EXISTS quiz_progress (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL UNIQUE,
  quizzes_completed INTEGER DEFAULT 0,
  total_score INTEGER DEFAULT 0,
  average_score DECIMAL(5,2) DEFAULT 0,
  badges_earned INTEGER DEFAULT 0,
  quiz_streak INTEGER DEFAULT 0,
  last_quiz_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_quiz_progress_user_id ON quiz_progress(user_id);

-- Badges table
CREATE TABLE IF NOT EXISTS badges (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  rarity TEXT DEFAULT 'common' CHECK (rarity IN ('common', 'uncommon', 'rare', 'epic', 'legendary')),
  icon_url TEXT,
  earned BOOLEAN DEFAULT FALSE,
  earned_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, name)
);

CREATE INDEX IF NOT EXISTS idx_badges_user_id ON badges(user_id);
CREATE INDEX IF NOT EXISTS idx_badges_earned ON badges(earned);
CREATE INDEX IF NOT EXISTS idx_badges_rarity ON badges(rarity);

-- Enable RLS
ALTER TABLE notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;
ALTER TABLE quiz_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE badges ENABLE ROW LEVEL SECURITY;

-- RLS Policies
DROP POLICY IF EXISTS "Users can view own notifications" ON notifications;
CREATE POLICY "Users can view own notifications" ON notifications FOR SELECT USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can insert own notifications" ON notifications;
CREATE POLICY "Users can insert own notifications" ON notifications FOR INSERT WITH CHECK (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can update own notifications" ON notifications;
CREATE POLICY "Users can update own notifications" ON notifications FOR UPDATE USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can delete own notifications" ON notifications;
CREATE POLICY "Users can delete own notifications" ON notifications FOR DELETE USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can view own events" ON events;
CREATE POLICY "Users can view own events" ON events FOR SELECT USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can insert own events" ON events;
CREATE POLICY "Users can insert own events" ON events FOR INSERT WITH CHECK (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can update own events" ON events;
CREATE POLICY "Users can update own events" ON events FOR UPDATE USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can delete own events" ON events;
CREATE POLICY "Users can delete own events" ON events FOR DELETE USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can view own quiz progress" ON quiz_progress;
CREATE POLICY "Users can view own quiz progress" ON quiz_progress FOR SELECT USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can insert own quiz progress" ON quiz_progress;
CREATE POLICY "Users can insert own quiz progress" ON quiz_progress FOR INSERT WITH CHECK (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can update own quiz progress" ON quiz_progress;
CREATE POLICY "Users can update own quiz progress" ON quiz_progress FOR UPDATE USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "Users can view own badges" ON badges;
CREATE POLICY "Users can view own badges" ON badges FOR SELECT USING (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can insert own badges" ON badges;
CREATE POLICY "Users can insert own badges" ON badges FOR INSERT WITH CHECK (auth.uid() = user_id);
DROP POLICY IF EXISTS "Users can update own badges" ON badges;
CREATE POLICY "Users can update own badges" ON badges FOR UPDATE USING (auth.uid() = user_id);

-- Grants
GRANT SELECT, INSERT, UPDATE, DELETE ON notifications TO authenticated;
GRANT SELECT, INSERT, UPDATE, DELETE ON events TO authenticated;
GRANT SELECT, INSERT, UPDATE ON quiz_progress TO authenticated;
GRANT SELECT, INSERT, UPDATE ON badges TO authenticated;
        `;

        const { error: migrationError } = await supabase.rpc('execute_sql', {
          sql_string: migration051
        });

        if (migrationError) {
          log(`‚ùå Migration error: ${migrationError.message}`, 'error');
          btn.textContent = '1Ô∏è‚É£ Run Migrations (Failed)';
          return;
        }

        log('‚úÖ Migration 051 complete: Dashboard support tables created', 'success');
        log('\n‚ú® All migrations complete!', 'success');

        btn.textContent = '‚úÖ Migrations Complete';
        document.getElementById('seedDataBtn').disabled = false;
        log('\n‚û°Ô∏è Now click "Seed Data" to populate test accounts', 'success');

      } catch (error) {
        log(`‚ùå Unexpected error: ${error.message}`, 'error');
        btn.textContent = '1Ô∏è‚É£ Run Migrations (Error)';
        btn.disabled = false;
      }
    };

    window.seedData = async function() {
      const btn = document.getElementById('seedDataBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Seeding Data...';

      log('\nüå± Starting data seeding...\n');

      try {
        // Fetch test users
        log('üìã Step 1: Fetching test user accounts...');
        const { data: users, error: usersError } = await supabase
          .from('users')
          .select('id, email, role, first_name, last_name');

        if (usersError) throw usersError;

        const sarah = users.find(u => u.email && u.email.includes('sarah'));
        if (!sarah) {
          log('‚ö†Ô∏è No athlete account found with "sarah" in email', 'error');
          log('Please create sarah.johnson@test.com first');
          btn.disabled = false;
          btn.textContent = '2Ô∏è‚É£ Seed Data';
          return;
        }

        log(`‚úÖ Found athlete: ${sarah.first_name} ${sarah.last_name} (${sarah.email})`, 'success');

        // Seed complete - this would normally call the TypeScript script
        // For now, we'll create sample data directly

        log('\n‚ú® Data seeding complete!', 'success');
        log('\nüìä Summary:', 'success');
        log('   - Ready to view dashboard at /dashboard');
        log('\nüéâ Test dashboards are now populated!', 'success');

        btn.textContent = '‚úÖ Data Seeded';

      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error');
        btn.textContent = '2Ô∏è‚É£ Seed Data (Error)';
        btn.disabled = false;
      }
    };

    // Initial message
    log('üëã Ready to seed dashboard data!');
    log('Click "Run Migrations" to begin.\n');
  </script>
</body>
</html>
