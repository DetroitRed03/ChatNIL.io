<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apply Migration 075 - Add Match Tier and Reasons</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid #2196f3;
    }
    .warning {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    button {
      background: #2196f3;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #1976d2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
      display: none;
    }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .info-text { color: #2196f3; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Migration 075: Add Match Tier and Reasons Columns</h1>

    <div class="info">
      <strong>üìã What this migration does:</strong>
      <ul>
        <li>Adds <code>match_tier</code> column (excellent/good/potential/poor)</li>
        <li>Adds <code>match_reasons</code> column (text array)</li>
        <li>Creates indexes for faster queries</li>
        <li>Fixes the "Generate Matches" button functionality</li>
      </ul>
    </div>

    <div class="warning">
      <strong>‚ö†Ô∏è Important:</strong> This migration is REQUIRED for the matchmaking feature to work.
      It adds columns that the API expects but were missing from the original schema.
    </div>

    <button id="runBtn" onclick="runMigration()">‚ñ∂Ô∏è Run Migration</button>
    <button onclick="checkStatus()">üîç Check Current Status</button>

    <div id="output"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://enbuwffusjhpcyoveewb.supabase.co';
    const SUPABASE_SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuYnV3ZmZ1c2pocGN5b3ZlZXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODY4NjcwOSwiZXhwIjoyMDc0MjYyNzA5fQ.fXvyvHrUoNLdAr1expbRsguM8fkmurrNQi3-7xk8-TM';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      output.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info-text';
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    async function checkStatus() {
      log('Checking current database schema...', 'info');

      try {
        // Check if columns exist
        const { data, error } = await supabase
          .from('agency_athlete_matches')
          .select('match_tier, match_reasons')
          .limit(1);

        if (error) {
          if (error.message.includes('column') && error.message.includes('does not exist')) {
            log('‚ùå Columns DO NOT exist. Migration is REQUIRED.', 'error');
            log('Columns missing: match_tier, match_reasons', 'error');
          } else {
            log(`Error: ${error.message}`, 'error');
          }
        } else {
          log('‚úÖ Columns already exist! Migration may have been run already.', 'success');
          log('Current schema appears correct.', 'success');
        }
      } catch (err) {
        log(`Unexpected error: ${err.message}`, 'error');
      }
    }

    async function runMigration() {
      const btn = document.getElementById('runBtn');
      btn.disabled = true;

      log('='.repeat(60), 'info');
      log('Starting Migration 075...', 'info');
      log('='.repeat(60), 'info');

      const migration = `
        -- Add match_tier column with constraint
        ALTER TABLE agency_athlete_matches
          ADD COLUMN IF NOT EXISTS match_tier TEXT
            CHECK (match_tier IN ('excellent', 'good', 'potential', 'poor'));

        -- Add match_reasons column (array of text)
        ALTER TABLE agency_athlete_matches
          ADD COLUMN IF NOT EXISTS match_reasons TEXT[];

        -- Add index on match_tier for faster filtering
        CREATE INDEX IF NOT EXISTS idx_matches_tier
          ON agency_athlete_matches(match_tier);

        -- Add index on agency_id and match_tier for common queries
        CREATE INDEX IF NOT EXISTS idx_matches_agency_tier
          ON agency_athlete_matches(agency_id, match_tier);
      `;

      try {
        log('Executing SQL migration...', 'info');

        const { data, error } = await supabase.rpc('exec_sql', {
          sql_query: migration
        });

        if (error) {
          log(`‚ùå Migration failed: ${error.message}`, 'error');
          log(JSON.stringify(error, null, 2), 'error');
          btn.disabled = false;
          return;
        }

        log('‚úÖ Migration executed successfully!', 'success');
        log('', 'info');
        log('Verifying changes...', 'info');

        // Verify the changes
        const { data: verifyData, error: verifyError } = await supabase
          .from('agency_athlete_matches')
          .select('match_tier, match_reasons')
          .limit(1);

        if (verifyError) {
          if (verifyError.message.includes('column') && verifyError.message.includes('does not exist')) {
            log('‚ö†Ô∏è Verification failed - columns still missing!', 'error');
            log('You may need to run this migration manually via SQL editor.', 'error');
          } else {
            log(`Verification error: ${verifyError.message}`, 'error');
          }
        } else {
          log('‚úÖ Verification passed! Columns exist.', 'success');
          log('', 'info');
          log('='.repeat(60), 'success');
          log('MIGRATION 075 COMPLETED SUCCESSFULLY!', 'success');
          log('='.repeat(60), 'success');
          log('', 'info');
          log('Next steps:', 'info');
          log('1. The "Generate Matches Now" button should now work', 'info');
          log('2. Try clicking it to generate AI matches', 'info');
          log('3. Check the browser console for detailed logs', 'info');
        }

      } catch (err) {
        log(`‚ùå Unexpected error: ${err.message}`, 'error');
        log(err.stack, 'error');
      } finally {
        btn.disabled = false;
      }
    }

    // Auto-check status on page load
    window.addEventListener('load', () => {
      setTimeout(checkStatus, 500);
    });
  </script>
</body>
</html>
