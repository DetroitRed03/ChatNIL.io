<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Populate Athlete Profiles - Migration 040</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .container {
      background: #1e293b;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }
    h1 {
      color: #60a5fa;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
    }
    button {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(96, 165, 250, 0.3);
    }
    button:disabled {
      background: #475569;
      cursor: not-allowed;
      transform: none;
    }
    #output {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      min-height: 300px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log {
      margin: 4px 0;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .log-info {
      color: #93c5fd;
    }
    .log-success {
      color: #6ee7b7;
      background: rgba(16, 185, 129, 0.1);
    }
    .log-error {
      color: #fca5a5;
      background: rgba(239, 68, 68, 0.1);
    }
    .log-warning {
      color: #fcd34d;
      background: rgba(245, 158, 11, 0.1);
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: #0f172a;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .stat-label {
      color: #94a3b8;
      font-size: 13px;
      margin-bottom: 5px;
    }
    .stat-value {
      color: #e2e8f0;
      font-size: 24px;
      font-weight: 600;
    }
    .profile-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .profile-name {
      font-size: 16px;
      font-weight: 600;
      color: #60a5fa;
    }
    .profile-sport {
      color: #94a3b8;
      font-size: 14px;
    }
    .profile-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
      font-size: 13px;
    }
    .profile-stat {
      color: #cbd5e1;
    }
    .profile-stat strong {
      color: #e2e8f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üë• Populate Athlete Public Profiles</h1>
    <p class="subtitle">Create public profiles for athlete discovery by agencies</p>

    <button id="runButton" onclick="runDataMigration()">‚ñ∂ Populate Profiles</button>

    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Athletes Found</div>
        <div class="stat-value" id="athletesFound">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Profiles Created</div>
        <div class="stat-value" id="profilesCreated">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Status</div>
        <div class="stat-value" id="status" style="font-size: 18px;">Ready</div>
      </div>
    </div>

    <div id="output"></div>
    <div id="profilesContainer"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://enbuwffusjhpcyoveewb.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuYnV3ZmZ1c2pocGN5b3ZlZXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1ODY4NjcwOSwiZXhwIjoyMDc0MjYyNzA5fQ.fXvyvHrUoNLdAr1expbRsguM8fkmurrNQi3-7xk8-TM';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

    const SPORT_FMV_RANGES = {
      'Basketball': [15000, 35000],
      'Football': [20000, 50000],
      'Soccer': [10000, 25000],
      'Baseball': [8000, 20000],
      'Volleyball': [6000, 15000],
      'Track': [5000, 12000],
      'default': [5000, 15000]
    };

    const CONTENT_CATEGORIES = [
      'fitness', 'lifestyle', 'fashion', 'gaming', 'food', 'travel',
      'sports', 'education', 'music', 'comedy', 'beauty', 'tech'
    ];

    const BRAND_VALUES = [
      'authenticity', 'excellence', 'community', 'innovation', 'sustainability',
      'empowerment', 'diversity', 'leadership', 'creativity', 'wellness'
    ];

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const logEntry = document.createElement('div');
      logEntry.className = `log log-${type}`;
      logEntry.textContent = message;
      output.appendChild(logEntry);
      output.scrollTop = output.scrollHeight;
    }

    function updateStats(athletesFound, profilesCreated, status) {
      document.getElementById('athletesFound').textContent = athletesFound;
      document.getElementById('profilesCreated').textContent = profilesCreated;
      document.getElementById('status').textContent = status;
    }

    function showProfile(profile) {
      const container = document.getElementById('profilesContainer');
      const card = document.createElement('div');
      card.className = 'profile-card';
      card.innerHTML = `
        <div class="profile-header">
          <div>
            <div class="profile-name">${profile.display_name}</div>
            <div class="profile-sport">${profile.sport} ‚Ä¢ ${profile.school_name}</div>
          </div>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><strong>Instagram:</strong> ${profile.instagram_followers?.toLocaleString()} followers (${profile.instagram_engagement_rate}%)</div>
          <div class="profile-stat"><strong>TikTok:</strong> ${profile.tiktok_followers?.toLocaleString()} followers (${profile.tiktok_engagement_rate}%)</div>
          <div class="profile-stat"><strong>Total Followers:</strong> ${profile.total_followers?.toLocaleString()}</div>
          <div class="profile-stat"><strong>FMV:</strong> $${profile.estimated_fmv_min?.toLocaleString()} - $${profile.estimated_fmv_max?.toLocaleString()}</div>
        </div>
      `;
      container.appendChild(card);
    }

    function randomChoice(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function randomChoices(array, count) {
      const shuffled = [...array].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    }

    async function runDataMigration() {
      const button = document.getElementById('runButton');
      button.disabled = true;
      button.textContent = '‚è≥ Running...';

      document.getElementById('output').innerHTML = '';
      document.getElementById('profilesContainer').innerHTML = '';
      document.getElementById('stats').style.display = 'grid';

      log('üèÉ Starting Athlete Public Profiles Migration', 'info');
      log('', 'info');

      updateStats(0, 0, 'Running');

      try {
        // Fetch athlete users
        log('üìã Fetching athlete users from database...', 'info');
        const { data: athletes, error: athletesError } = await supabase
          .from('users')
          .select('*')
          .eq('role', 'athlete');

        if (athletesError) {
          throw new Error(`Failed to fetch athletes: ${athletesError.message}`);
        }

        log(`‚úÖ Found ${athletes.length} athlete users`, 'success');
        log('', 'info');

        updateStats(athletes.length, 0, 'Processing');

        let successCount = 0;
        let failedCount = 0;

        // Process each athlete
        for (let i = 0; i < athletes.length; i++) {
          const athlete = athletes[i];
          const displayName = `${athlete.first_name || 'Unknown'} ${athlete.last_name || 'Athlete'}`;

          log(`Processing ${i + 1}/${athletes.length}: ${displayName}`, 'info');

          const sport = athlete.primary_sport || 'Basketball';
          const fmvRange = SPORT_FMV_RANGES[sport] || SPORT_FMV_RANGES['default'];

          // Generate realistic follower counts based on sport
          const baseFollowers = (sport === 'Basketball' || sport === 'Football') ? 200000 : 50000;
          const variance = Math.random() * 0.5 + 0.75;

          const instagramFollowers = Math.floor(baseFollowers * variance);
          const tiktokFollowers = Math.floor(baseFollowers * 0.7 * variance);
          const twitterFollowers = Math.floor(baseFollowers * 0.5 * variance);
          const youtubeSubscribers = Math.floor(baseFollowers * 0.3 * variance);

          const instagramEngagement = Number((Math.random() * 5 + 4).toFixed(2));
          const tiktokEngagement = Number((Math.random() * 8 + 6).toFixed(2));

          const publicProfile = {
            user_id: athlete.id,
            display_name: displayName,
            bio: athlete.bio || null,
            sport: sport,
            position: athlete.position || null,
            school_name: athlete.school_name || 'Unknown School',
            school_level: athlete.school_name?.toLowerCase().includes('high') ? 'high_school' : 'college',
            graduation_year: athlete.graduation_year || null,
            state: 'KY',
            city: null,

            // Social handles
            instagram_handle: `@${athlete.first_name?.toLowerCase() || 'athlete'}${Math.floor(Math.random() * 999)}`,
            tiktok_handle: `@${athlete.first_name?.toLowerCase() || 'athlete'}${Math.floor(Math.random() * 999)}`,
            twitter_handle: `@${athlete.first_name?.toLowerCase() || 'athlete'}${Math.floor(Math.random() * 999)}`,

            // Social stats
            instagram_followers: instagramFollowers,
            instagram_engagement_rate: instagramEngagement,
            tiktok_followers: tiktokFollowers,
            tiktok_engagement_rate: tiktokEngagement,
            twitter_followers: twitterFollowers,
            youtube_subscribers: youtubeSubscribers,

            // FMV
            estimated_fmv_min: fmvRange[0],
            estimated_fmv_max: fmvRange[1],
            avg_engagement_rate: Number(((instagramEngagement + tiktokEngagement) / 2).toFixed(2)),

            // Brand fit
            content_categories: randomChoices(CONTENT_CATEGORIES, 3 + Math.floor(Math.random() * 3)),
            brand_values: randomChoices(BRAND_VALUES, 3 + Math.floor(Math.random() * 2)),
            audience_demographics: {
              age_range: '16-24',
              gender: 'mixed',
              location: 'Kentucky'
            },

            // Availability
            is_available_for_partnerships: true,
            preferred_partnership_types: ['sponsored_posts', 'brand_ambassador', 'content_creation'],
            response_rate: Number((Math.random() * 20 + 80).toFixed(0)),
            avg_response_time_hours: Math.floor(Math.random() * 24) + 2,

            // Verification
            is_verified: false,
            verification_badges: [],

            // Stats
            total_partnerships_completed: Math.floor(Math.random() * 5),
            total_campaign_impressions: null,
            avg_campaign_performance: null,

            // Activity
            last_active_at: new Date().toISOString(),

            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          };

          // Insert profile
          const { data: insertedProfile, error: insertError } = await supabase
            .from('athlete_public_profiles')
            .upsert(publicProfile, { onConflict: 'user_id' })
            .select()
            .single();

          if (insertError) {
            log(`  ‚ùå Failed: ${insertError.message}`, 'error');
            failedCount++;
          } else {
            log(`  ‚úÖ Created profile for ${displayName}`, 'success');
            successCount++;
            updateStats(athletes.length, successCount, 'Processing');
            showProfile(insertedProfile);
          }
        }

        log('', 'info');
        log('‚ïê'.repeat(60), 'info');
        log(`‚úÖ Migration complete!`, 'success');
        log(`   Successfully created: ${successCount}`, 'success');
        if (failedCount > 0) {
          log(`   Failed: ${failedCount}`, 'error');
        }

        updateStats(athletes.length, successCount, '‚úÖ Complete');
        button.textContent = '‚úÖ Migration Complete';
        button.style.background = '#10b981';

        log('', 'info');
        log('Next step:', 'info');
        log('  Run verification: npx tsx scripts/verify-agency-platform.ts', 'info');

      } catch (error) {
        log('', 'info');
        log(`‚ùå Migration failed: ${error.message}`, 'error');
        updateStats(0, 0, '‚ùå Failed');
        button.textContent = '‚ùå Migration Failed';
        button.style.background = '#ef4444';
      }
    }
  </script>
</body>
</html>
