<!DOCTYPE html>
<html>
<head>
  <title>Apply Migration 100: Agency Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #667eea; margin-bottom: 10px; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px 5px;
    }
    button:hover { transform: translateY(-2px); transition: 0.2s; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 600px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    .info { color: #60a5fa; }
    .progress {
      background: #e5e7eb;
      height: 8px;
      border-radius: 4px;
      margin: 20px 0;
    }
    .progress-bar {
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      height: 100%;
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Migration 100: Agency Dashboard Infrastructure</h1>
    <p>This will create all tables, views, and functions for the agency dashboard.</p>

    <button id="applyBtn">Apply Migration 100</button>

    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <div id="output"></div>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://lqskiijspudfocddkhqs.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxc2tpaWpzcHVkZm9jZGRraHFzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU5MzM1NCwiZXhwIjoyMDc3MTY5MzU0fQ.LpapT51choXCwTfpbE81AIc4JC9QOO0FpOtqUxZ405I';

    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
    const output = document.getElementById('output');
    const progressBar = document.getElementById('progressBar');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = message;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    function updateProgress(percent) {
      progressBar.style.width = percent + '%';
    }

    async function executeSQLDirect(sql, description) {
      try {
        const { error } = await window.supabase.rpc('exec_sql', { query: sql });
        if (error) throw new Error(error.message);
        log(`  ‚úÖ ${description}`, 'success');
        return true;
      } catch (error) {
        log(`  ‚ùå ${description}: ${error.message}`, 'error');
        return false;
      }
    }

    async function applyMigration() {
      const btn = document.getElementById('applyBtn');
      btn.disabled = true;
      output.innerHTML = '';

      log('üîÑ Starting Migration 100: Agency Dashboard Infrastructure\\n', 'info');
      updateProgress(5);

      try {
        // Read the migration file content (embedded)
        const migrationSQL = \`-- ============================================================================
-- MIGRATION 100: Agency Dashboard Infrastructure
-- ============================================================================

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- TABLE: campaigns
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.campaigns (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'pending', 'active', 'completed', 'cancelled')),
  campaign_type TEXT,
  total_budget NUMERIC NOT NULL DEFAULT 0,
  spent_budget NUMERIC NOT NULL DEFAULT 0,
  start_date TIMESTAMPTZ,
  end_date TIMESTAMPTZ,
  total_athletes INTEGER DEFAULT 0,
  total_impressions BIGINT DEFAULT 0,
  total_engagement BIGINT DEFAULT 0,
  engagement_rate NUMERIC DEFAULT 0,
  goals JSONB DEFAULT '{}',
  target_audience JSONB DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_campaigns_agency_id ON public.campaigns(agency_id);
CREATE INDEX IF NOT EXISTS idx_campaigns_status ON public.campaigns(status);
CREATE INDEX IF NOT EXISTS idx_campaigns_dates ON public.campaigns(start_date, end_date);

ALTER TABLE public.campaigns ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can view own campaigns" ON public.campaigns;
CREATE POLICY "Agencies can view own campaigns" ON public.campaigns FOR SELECT USING (auth.uid() = agency_id);

DROP POLICY IF EXISTS "Agencies can create own campaigns" ON public.campaigns;
CREATE POLICY "Agencies can create own campaigns" ON public.campaigns FOR INSERT WITH CHECK (auth.uid() = agency_id);

DROP POLICY IF EXISTS "Agencies can update own campaigns" ON public.campaigns;
CREATE POLICY "Agencies can update own campaigns" ON public.campaigns FOR UPDATE USING (auth.uid() = agency_id);

DROP POLICY IF EXISTS "Agencies can delete own campaigns" ON public.campaigns;
CREATE POLICY "Agencies can delete own campaigns" ON public.campaigns FOR DELETE USING (auth.uid() = agency_id);

-- ============================================================================
-- TABLE: campaign_athletes
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.campaign_athletes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  campaign_id UUID NOT NULL REFERENCES public.campaigns(id) ON DELETE CASCADE,
  athlete_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  compensation NUMERIC,
  status TEXT DEFAULT 'invited' CHECK (status IN ('invited', 'accepted', 'declined', 'active', 'completed')),
  impressions BIGINT DEFAULT 0,
  engagement BIGINT DEFAULT 0,
  engagement_rate NUMERIC DEFAULT 0,
  conversions INTEGER DEFAULT 0,
  deliverables JSONB DEFAULT '[]',
  completed_deliverables INTEGER DEFAULT 0,
  total_deliverables INTEGER DEFAULT 0,
  invited_at TIMESTAMPTZ DEFAULT NOW(),
  accepted_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(campaign_id, athlete_id)
);

CREATE INDEX IF NOT EXISTS idx_campaign_athletes_campaign ON public.campaign_athletes(campaign_id);
CREATE INDEX IF NOT EXISTS idx_campaign_athletes_athlete ON public.campaign_athletes(athlete_id);
CREATE INDEX IF NOT EXISTS idx_campaign_athletes_status ON public.campaign_athletes(status);

ALTER TABLE public.campaign_athletes ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can view campaign athletes" ON public.campaign_athletes;
CREATE POLICY "Agencies can view campaign athletes" ON public.campaign_athletes FOR SELECT USING (
  EXISTS (SELECT 1 FROM public.campaigns WHERE campaigns.id = campaign_id AND campaigns.agency_id = auth.uid())
);

DROP POLICY IF EXISTS "Athletes can view their campaign assignments" ON public.campaign_athletes;
CREATE POLICY "Athletes can view their campaign assignments" ON public.campaign_athletes FOR SELECT USING (auth.uid() = athlete_id);

DROP POLICY IF EXISTS "Agencies can manage campaign athletes" ON public.campaign_athletes;
CREATE POLICY "Agencies can manage campaign athletes" ON public.campaign_athletes FOR ALL USING (
  EXISTS (SELECT 1 FROM public.campaigns WHERE campaigns.id = campaign_id AND campaigns.agency_id = auth.uid())
);

-- ============================================================================
-- TABLE: campaign_metrics
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.campaign_metrics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  campaign_id UUID NOT NULL REFERENCES public.campaigns(id) ON DELETE CASCADE,
  athlete_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  metric_date DATE NOT NULL,
  impressions BIGINT DEFAULT 0,
  engagement BIGINT DEFAULT 0,
  clicks INTEGER DEFAULT 0,
  conversions INTEGER DEFAULT 0,
  spend NUMERIC DEFAULT 0,
  cpm NUMERIC,
  cpc NUMERIC,
  conversion_rate NUMERIC,
  roi NUMERIC,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(campaign_id, athlete_id, metric_date)
);

CREATE INDEX IF NOT EXISTS idx_campaign_metrics_campaign ON public.campaign_metrics(campaign_id);
CREATE INDEX IF NOT EXISTS idx_campaign_metrics_date ON public.campaign_metrics(metric_date DESC);
CREATE INDEX IF NOT EXISTS idx_campaign_metrics_campaign_date ON public.campaign_metrics(campaign_id, metric_date DESC);

ALTER TABLE public.campaign_metrics ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can view campaign metrics" ON public.campaign_metrics;
CREATE POLICY "Agencies can view campaign metrics" ON public.campaign_metrics FOR SELECT USING (
  EXISTS (SELECT 1 FROM public.campaigns WHERE campaigns.id = campaign_id AND campaigns.agency_id = auth.uid())
);

-- ============================================================================
-- TABLE: agency_budget_allocations
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.agency_budget_allocations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  period_name TEXT NOT NULL,
  period_start DATE NOT NULL,
  period_end DATE NOT NULL,
  total_budget NUMERIC NOT NULL,
  allocated_budget NUMERIC DEFAULT 0,
  spent_budget NUMERIC DEFAULT 0,
  categories JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(agency_id, period_start, period_end)
);

CREATE INDEX IF NOT EXISTS idx_budget_allocations_agency ON public.agency_budget_allocations(agency_id);
CREATE INDEX IF NOT EXISTS idx_budget_allocations_period ON public.agency_budget_allocations(period_start, period_end);

ALTER TABLE public.agency_budget_allocations ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can manage own budget" ON public.agency_budget_allocations;
CREATE POLICY "Agencies can manage own budget" ON public.agency_budget_allocations FOR ALL USING (auth.uid() = agency_id);

-- ============================================================================
-- TABLE: agency_activity_log
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.agency_activity_log (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  activity_type TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  related_type TEXT,
  related_id UUID,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_activity_log_agency ON public.agency_activity_log(agency_id);
CREATE INDEX IF NOT EXISTS idx_activity_log_created ON public.agency_activity_log(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_activity_log_type ON public.agency_activity_log(activity_type);

ALTER TABLE public.agency_activity_log ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can view own activity" ON public.agency_activity_log;
CREATE POLICY "Agencies can view own activity" ON public.agency_activity_log FOR SELECT USING (auth.uid() = agency_id);

-- ============================================================================
-- TABLE: agency_pending_actions
-- ============================================================================
CREATE TABLE IF NOT EXISTS public.agency_pending_actions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  action_type TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  priority TEXT DEFAULT 'medium' CHECK (priority IN ('low', 'medium', 'high', 'urgent')),
  related_type TEXT,
  related_id UUID,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed', 'dismissed')),
  completed_at TIMESTAMPTZ,
  completed_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  due_date TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_pending_actions_agency ON public.agency_pending_actions(agency_id);
CREATE INDEX IF NOT EXISTS idx_pending_actions_status ON public.agency_pending_actions(status);
CREATE INDEX IF NOT EXISTS idx_pending_actions_priority ON public.agency_pending_actions(priority);
CREATE INDEX IF NOT EXISTS idx_pending_actions_due ON public.agency_pending_actions(due_date);

ALTER TABLE public.agency_pending_actions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Agencies can manage own actions" ON public.agency_pending_actions;
CREATE POLICY "Agencies can manage own actions" ON public.agency_pending_actions FOR ALL USING (auth.uid() = agency_id);

-- ============================================================================
-- VIEW: agency_dashboard_stats
-- ============================================================================
CREATE OR REPLACE VIEW public.agency_dashboard_stats AS
SELECT
  c.agency_id,
  COUNT(DISTINCT c.id) as total_campaigns,
  COUNT(DISTINCT c.id) FILTER (WHERE c.status = 'active') as active_campaigns,
  COUNT(DISTINCT c.id) FILTER (WHERE c.status = 'pending') as pending_campaigns,
  COUNT(DISTINCT ca.athlete_id) as total_athletes,
  COUNT(DISTINCT ca.athlete_id) FILTER (WHERE ca.status = 'active') as active_athletes,
  COALESCE(SUM(c.total_budget), 0) as total_budget,
  COALESCE(SUM(c.spent_budget), 0) as spent_budget,
  COALESCE(SUM(c.total_budget) - SUM(c.spent_budget), 0) as remaining_budget,
  COALESCE(SUM(c.total_impressions), 0) as total_impressions,
  COALESCE(SUM(c.total_engagement), 0) as total_engagement,
  CASE
    WHEN SUM(c.total_impressions) > 0
    THEN (SUM(c.total_engagement)::NUMERIC / SUM(c.total_impressions)::NUMERIC * 100)
    ELSE 0
  END as avg_engagement_rate,
  CASE
    WHEN SUM(c.spent_budget) > 0
    THEN ((SUM(c.total_engagement)::NUMERIC / SUM(c.spent_budget)::NUMERIC) * 100)
    ELSE 0
  END as roi_percentage
FROM public.campaigns c
LEFT JOIN public.campaign_athletes ca ON ca.campaign_id = c.id
WHERE c.agency_id = auth.uid()
GROUP BY c.agency_id;

GRANT SELECT ON public.agency_dashboard_stats TO authenticated;

-- ============================================================================
-- VIEW: campaign_performance_detail
-- ============================================================================
CREATE OR REPLACE VIEW public.campaign_performance_detail AS
SELECT
  c.id,
  c.agency_id,
  c.name,
  c.status,
  c.total_budget,
  c.spent_budget,
  c.start_date,
  c.end_date,
  COUNT(DISTINCT ca.athlete_id) as athletes_count,
  COALESCE(SUM(ca.impressions), 0) as total_impressions,
  COALESCE(SUM(ca.engagement), 0) as total_engagement,
  CASE
    WHEN SUM(ca.impressions) > 0
    THEN (SUM(ca.engagement)::NUMERIC / SUM(ca.impressions)::NUMERIC * 100)
    ELSE 0
  END as engagement_rate,
  COALESCE(SUM(ca.completed_deliverables), 0) as completed_deliverables,
  COALESCE(SUM(ca.total_deliverables), 0) as total_deliverables,
  CASE
    WHEN SUM(ca.total_deliverables) > 0
    THEN (SUM(ca.completed_deliverables)::NUMERIC / SUM(ca.total_deliverables)::NUMERIC * 100)
    ELSE 0
  END as deliverables_progress,
  c.created_at,
  c.updated_at
FROM public.campaigns c
LEFT JOIN public.campaign_athletes ca ON ca.campaign_id = c.id
GROUP BY c.id, c.agency_id, c.name, c.status, c.total_budget, c.spent_budget,
         c.start_date, c.end_date, c.created_at, c.updated_at;

GRANT SELECT ON public.campaign_performance_detail TO authenticated;

-- ============================================================================
-- VIEW: agency_athlete_roster
-- ============================================================================
CREATE OR REPLACE VIEW public.agency_athlete_roster AS
SELECT DISTINCT ON (ca.athlete_id, c.agency_id)
  c.agency_id,
  u.id as athlete_id,
  u.email,
  u.full_name,
  u.avatar_url,
  u.sport,
  u.school,
  fmv.fmv_score,
  fmv.fmv_tier,
  COUNT(DISTINCT ca.campaign_id) as total_campaigns,
  COUNT(DISTINCT ca.campaign_id) FILTER (WHERE ca.status = 'active') as active_campaigns,
  COALESCE(SUM(ca.impressions), 0) as total_impressions,
  COALESCE(SUM(ca.engagement), 0) as total_engagement,
  CASE
    WHEN SUM(ca.impressions) > 0
    THEN (SUM(ca.engagement)::NUMERIC / SUM(ca.impressions)::NUMERIC * 100)
    ELSE 0
  END as engagement_rate,
  MAX(ca.updated_at) as last_activity
FROM public.campaigns c
JOIN public.campaign_athletes ca ON ca.campaign_id = c.id
JOIN auth.users u ON u.id = ca.athlete_id
LEFT JOIN public.athlete_fmv_data fmv ON fmv.athlete_id = u.id
GROUP BY c.agency_id, u.id, u.email, u.full_name, u.avatar_url,
         u.sport, u.school, fmv.fmv_score, fmv.fmv_tier;

GRANT SELECT ON public.agency_athlete_roster TO authenticated;

-- ============================================================================
-- FUNCTION: update_campaign_metrics
-- ============================================================================
CREATE OR REPLACE FUNCTION public.update_campaign_metrics()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE public.campaigns
  SET
    total_athletes = (
      SELECT COUNT(DISTINCT athlete_id)
      FROM public.campaign_athletes
      WHERE campaign_id = NEW.campaign_id
    ),
    total_impressions = (
      SELECT COALESCE(SUM(impressions), 0)
      FROM public.campaign_athletes
      WHERE campaign_id = NEW.campaign_id
    ),
    total_engagement = (
      SELECT COALESCE(SUM(engagement), 0)
      FROM public.campaign_athletes
      WHERE campaign_id = NEW.campaign_id
    ),
    engagement_rate = CASE
      WHEN (
        SELECT SUM(impressions)
        FROM public.campaign_athletes
        WHERE campaign_id = NEW.campaign_id
      ) > 0 THEN (
        SELECT (SUM(engagement)::NUMERIC / SUM(impressions)::NUMERIC * 100)
        FROM public.campaign_athletes
        WHERE campaign_id = NEW.campaign_id
      )
      ELSE 0
    END,
    updated_at = NOW()
  WHERE id = NEW.campaign_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS trigger_update_campaign_metrics ON public.campaign_athletes;
CREATE TRIGGER trigger_update_campaign_metrics
  AFTER INSERT OR UPDATE OF impressions, engagement ON public.campaign_athletes
  FOR EACH ROW
  EXECUTE FUNCTION public.update_campaign_metrics();

-- ============================================================================
-- FUNCTION: log_agency_activity
-- ============================================================================
CREATE OR REPLACE FUNCTION public.log_agency_activity(
  p_agency_id UUID,
  p_activity_type TEXT,
  p_title TEXT,
  p_description TEXT DEFAULT NULL,
  p_related_type TEXT DEFAULT NULL,
  p_related_id UUID DEFAULT NULL,
  p_metadata JSONB DEFAULT '{}'
)
RETURNS UUID AS $$
DECLARE
  v_activity_id UUID;
BEGIN
  INSERT INTO public.agency_activity_log (
    agency_id,
    activity_type,
    title,
    description,
    related_type,
    related_id,
    user_id,
    metadata
  ) VALUES (
    p_agency_id,
    p_activity_type,
    p_title,
    p_description,
    p_related_type,
    p_related_id,
    auth.uid(),
    p_metadata
  )
  RETURNING id INTO v_activity_id;

  RETURN v_activity_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.log_agency_activity(UUID, TEXT, TEXT, TEXT, TEXT, UUID, JSONB) TO authenticated;

-- ============================================================================
-- FUNCTION: get_agency_dashboard_stats
-- ============================================================================
CREATE OR REPLACE FUNCTION public.get_agency_dashboard_stats(p_agency_id UUID)
RETURNS TABLE (
  total_campaigns BIGINT,
  active_campaigns BIGINT,
  pending_campaigns BIGINT,
  total_athletes BIGINT,
  active_athletes BIGINT,
  total_budget NUMERIC,
  spent_budget NUMERIC,
  remaining_budget NUMERIC,
  total_impressions BIGINT,
  total_engagement BIGINT,
  avg_engagement_rate NUMERIC,
  roi_percentage NUMERIC
) AS $$
BEGIN
  RETURN QUERY
  SELECT * FROM public.agency_dashboard_stats
  WHERE agency_id = p_agency_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.get_agency_dashboard_stats(UUID) TO authenticated;\`;

        log('üì¶ Applying consolidated migration...\\n', 'info');
        updateProgress(10);

        const success = await executeSQLDirect(migrationSQL, 'Migration 100 complete');

        if (success) {
          updateProgress(100);
          log('\\n' + '='.repeat(60), 'info');
          log('\\nüéâ Migration 100 applied successfully!', 'success');
          log('\\n‚úÖ Created:', 'success');
          log('  - campaigns table', 'info');
          log('  - campaign_athletes table', 'info');
          log('  - campaign_metrics table', 'info');
          log('  - agency_budget_allocations table', 'info');
          log('  - agency_activity_log table', 'info');
          log('  - agency_pending_actions table', 'info');
          log('  - agency_dashboard_stats view', 'info');
          log('  - campaign_performance_detail view', 'info');
          log('  - agency_athlete_roster view', 'info');
          log('  - update_campaign_metrics() function', 'info');
          log('  - log_agency_activity() function', 'info');
          log('  - get_agency_dashboard_stats() function', 'info');
          log('  - All RLS policies and indexes', 'info');
          log('\\nüìç Next: Backend API endpoints will be created', 'info');
        } else {
          updateProgress(100);
          log('\\n‚ùå Migration failed', 'error');
        }

      } catch (error) {
        log('\\n‚ùå Fatal error: ' + error.message, 'error');
        updateProgress(100);
      } finally {
        btn.disabled = false;
      }
    }

    // Attach event listener
    document.getElementById('applyBtn').addEventListener('click', applyMigration);
  </script>
</body>
</html>
