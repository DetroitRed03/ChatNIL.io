<!DOCTYPE html>
<html>
<head>
  <title>Setup NEW Supabase Database v2</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1000px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { color: #667eea; margin-bottom: 10px; }
    .step { margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      margin: 10px 5px;
    }
    button:hover { transform: translateY(-2px); transition: 0.2s; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 600px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Setup NEW Supabase Database</h1>
    <p><strong>Step 1 Complete!</strong> Now applying migrations...</p>

    <div class="step">
      <h3>Step 2: Apply All Migrations (One Click)</h3>
      <button id="migrateBtn" onclick="applyAllMigrations()">Apply All Migrations Now</button>
    </div>

    <div class="step">
      <h3>Step 3: Seed Test Data</h3>
      <button id="seedBtn" onclick="seedData()" disabled>Seed Test Data</button>
    </div>

    <div id="output"></div>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://lqskiijspudfocddkhqs.supabase.co';
    const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxxc2tpaWpzcHVkZm9jZGRoa3FzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTU5MzM1NCwiZXhwIjoyMDc3MTY5MzU0fQ.LpapT51choXCwTfpbE81AIc4JC9QOO0FpOtqUxZ405I';

    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = type;
      line.textContent = message;
      output.appendChild(line);
      output.scrollTop = output.scrollHeight;
    }

    async function executeSQLDirect(sql, description) {
      try {
        const { error } = await window.supabase.rpc('exec_sql', { query: sql });

        if (error) {
          throw new Error(error.message);
        }

        log(`  ‚úÖ ${description}`, 'success');
        return true;
      } catch (error) {
        log(`  ‚ùå ${description}: ${error.message}`, 'error');
        return false;
      }
    }

    window.applyAllMigrations = async function() {
      const btn = document.getElementById('migrateBtn');
      btn.disabled = true;
      output.innerHTML = '';

      log('üîÑ Starting migration to NEW Supabase...\\n', 'info');
      log(`Target: ${SUPABASE_URL}\\n`, 'info');

      // Create one consolidated SQL migration
      const consolidatedSQL = `
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create agencies table
CREATE TABLE IF NOT EXISTS public.agencies (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  company_name TEXT NOT NULL,
  agency_type TEXT,
  industry TEXT,
  company_size TEXT,
  website TEXT,
  logo_url TEXT,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.agencies ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view all agencies" ON public.agencies FOR SELECT USING (true);
CREATE POLICY "Agencies can update own profile" ON public.agencies FOR UPDATE USING (auth.uid() = id);

-- Create athlete_fmv_data table
CREATE TABLE IF NOT EXISTS public.athlete_fmv_data (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  athlete_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  fmv_score INTEGER,
  fmv_tier TEXT,
  percentile_rank INTEGER,
  deal_value_min NUMERIC,
  deal_value_max NUMERIC,
  is_public_score BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(athlete_id)
);

ALTER TABLE public.athlete_fmv_data ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Athletes can view own FMV" ON public.athlete_fmv_data FOR SELECT USING (auth.uid() = athlete_id OR is_public_score = true);

-- Create agency_athlete_matches table
CREATE TABLE IF NOT EXISTS public.agency_athlete_matches (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  agency_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  athlete_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  match_score INTEGER NOT NULL,
  tier TEXT,
  status TEXT DEFAULT 'active',
  match_reasons TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(agency_id, athlete_id)
);

ALTER TABLE public.agency_athlete_matches ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own matches" ON public.agency_athlete_matches FOR SELECT USING (auth.uid() = agency_id OR auth.uid() = athlete_id);

-- Create agency_athlete_messages table
CREATE TABLE IF NOT EXISTS public.agency_athlete_messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  match_id UUID NOT NULL REFERENCES public.agency_athlete_matches(id) ON DELETE CASCADE,
  sender_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  read_at TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.agency_athlete_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view messages in their matches" ON public.agency_athlete_messages FOR SELECT
  USING (EXISTS (
    SELECT 1 FROM public.agency_athlete_matches
    WHERE id = match_id AND (agency_id = auth.uid() OR athlete_id = auth.uid())
  ));

CREATE POLICY "Users can send messages in their matches" ON public.agency_athlete_messages FOR INSERT
  WITH CHECK (EXISTS (
    SELECT 1 FROM public.agency_athlete_matches
    WHERE id = match_id AND (agency_id = auth.uid() OR athlete_id = auth.uid())
  ) AND sender_id = auth.uid());

CREATE INDEX IF NOT EXISTS idx_messages_match_id ON public.agency_athlete_messages(match_id);
CREATE INDEX IF NOT EXISTS idx_messages_created_at ON public.agency_athlete_messages(created_at DESC);

-- Create quiz_questions table
CREATE TABLE IF NOT EXISTS public.quiz_questions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  category TEXT NOT NULL,
  question TEXT NOT NULL,
  options TEXT[] NOT NULL,
  correct_answer INTEGER NOT NULL,
  difficulty TEXT NOT NULL,
  points INTEGER NOT NULL DEFAULT 10,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE public.quiz_questions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view quiz questions" ON public.quiz_questions FOR SELECT USING (true);

-- Create conversation_summaries view
CREATE OR REPLACE VIEW public.conversation_summaries AS
SELECT
  m.match_id,
  m.match_id as conversation_id,
  COUNT(*) as total_messages,
  COUNT(*) FILTER (WHERE m.read_at IS NULL AND m.sender_id != auth.uid()) as unread_count,
  MAX(m.created_at) as last_message_at,
  (SELECT content FROM public.agency_athlete_messages WHERE match_id = m.match_id ORDER BY created_at DESC LIMIT 1) as last_message,
  (SELECT sender_id FROM public.agency_athlete_messages WHERE match_id = m.match_id ORDER BY created_at DESC LIMIT 1) as last_sender_id,
  ma.agency_id,
  ma.athlete_id,
  ma.status as match_status,
  ma.match_score,
  ma.tier,
  ag.company_name as agency_name,
  ag.logo_url as agency_logo
FROM public.agency_athlete_messages m
JOIN public.agency_athlete_matches ma ON ma.id = m.match_id
LEFT JOIN public.agencies ag ON ag.id = ma.agency_id
WHERE ma.agency_id = auth.uid() OR ma.athlete_id = auth.uid()
GROUP BY m.match_id, ma.agency_id, ma.athlete_id, ma.status, ma.match_score, ma.tier, ag.company_name, ag.logo_url
ORDER BY last_message_at DESC NULLS LAST;

GRANT SELECT ON public.conversation_summaries TO authenticated;

-- Create mark_messages_read function
CREATE OR REPLACE FUNCTION public.mark_messages_read(p_match_id UUID)
RETURNS TABLE (updated_count INTEGER, success BOOLEAN, error_message TEXT) AS $$
DECLARE
  v_user_id UUID;
  v_is_participant BOOLEAN;
  v_updated_count INTEGER;
BEGIN
  v_user_id := auth.uid();

  IF v_user_id IS NULL THEN
    RETURN QUERY SELECT 0, FALSE, 'Not authenticated'::TEXT;
    RETURN;
  END IF;

  SELECT EXISTS(
    SELECT 1 FROM public.agency_athlete_matches
    WHERE id = p_match_id AND (agency_id = v_user_id OR athlete_id = v_user_id)
  ) INTO v_is_participant;

  IF NOT v_is_participant THEN
    RETURN QUERY SELECT 0, FALSE, 'Not authorized'::TEXT;
    RETURN;
  END IF;

  WITH updated AS (
    UPDATE public.agency_athlete_messages
    SET read_at = NOW()
    WHERE match_id = p_match_id
      AND sender_id != v_user_id
      AND read_at IS NULL
    RETURNING id
  )
  SELECT COUNT(*)::INTEGER INTO v_updated_count FROM updated;

  RETURN QUERY SELECT v_updated_count, TRUE, NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.mark_messages_read(UUID) TO authenticated;

-- Create get_unread_count function
CREATE OR REPLACE FUNCTION public.get_unread_count()
RETURNS TABLE (total_unread INTEGER, conversations_with_unread INTEGER) AS $$
DECLARE
  v_user_id UUID;
  v_total_unread INTEGER;
  v_conversations_with_unread INTEGER;
BEGIN
  v_user_id := auth.uid();

  IF v_user_id IS NULL THEN
    RETURN QUERY SELECT 0, 0;
    RETURN;
  END IF;

  SELECT COUNT(*)::INTEGER INTO v_total_unread
  FROM public.agency_athlete_messages m
  JOIN public.agency_athlete_matches ma ON ma.id = m.match_id
  WHERE (ma.agency_id = v_user_id OR ma.athlete_id = v_user_id)
    AND m.sender_id != v_user_id
    AND m.read_at IS NULL;

  SELECT COUNT(DISTINCT m.match_id)::INTEGER INTO v_conversations_with_unread
  FROM public.agency_athlete_messages m
  JOIN public.agency_athlete_matches ma ON ma.id = m.match_id
  WHERE (ma.agency_id = v_user_id OR ma.athlete_id = v_user_id)
    AND m.sender_id != v_user_id
    AND m.read_at IS NULL;

  RETURN QUERY SELECT v_total_unread, v_conversations_with_unread;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

GRANT EXECUTE ON FUNCTION public.get_unread_count() TO authenticated;
      `;

      log('üì¶ Applying consolidated migration...\\n', 'info');

      const success = await executeSQLDirect(consolidatedSQL, 'Applied all core tables and functions');

      if (success) {
        log('\\nüéâ All migrations applied successfully!\\n', 'success');
        log('‚úÖ Created:', 'info');
        log('  - agencies table', 'success');
        log('  - athlete_fmv_data table', 'success');
        log('  - agency_athlete_matches table', 'success');
        log('  - agency_athlete_messages table', 'success');
        log('  - quiz_questions table', 'success');
        log('  - conversation_summaries view', 'success');
        log('  - mark_messages_read() function', 'success');
        log('  - get_unread_count() function', 'success');
        log('  - All RLS policies', 'success');
        log('\\nüìç Next: Click "Seed Test Data" button', 'info');

        document.getElementById('seedBtn').disabled = false;
      } else {
        log('\\n‚ùå Migration failed. Check errors above.', 'error');
      }

      btn.disabled = false;
    };

    window.seedData = async function() {
      const btn = document.getElementById('seedBtn');
      btn.disabled = true;
      output.innerHTML = '';

      log('üå± Seeding test data to NEW database...\\n', 'info');

      // Create test athlete
      const athleteEmail = `sarah.johnson.${Date.now()}@test.com`;
      log(`Creating athlete: ${athleteEmail}`, 'info');

      const { data: athlete, error: athleteError } = await window.supabase.auth.admin.createUser({
        email: athleteEmail,
        password: 'testpassword123',
        email_confirm: true,
        user_metadata: {
          first_name: 'Sarah',
          last_name: 'Johnson',
          role: 'athlete',
        },
      });

      if (athleteError) {
        log(`‚ùå Error: ${athleteError.message}`, 'error');
      } else {
        log(`‚úÖ Created athlete: ${athlete.user.id}`, 'success');

        // Create FMV data
        await window.supabase.from('athlete_fmv_data').insert({
          athlete_id: athlete.user.id,
          fmv_score: 52,
          fmv_tier: 'developing',
          percentile_rank: 49,
          deal_value_min: 1850,
          deal_value_max: 4162.50,
          is_public_score: true,
        });
        log('  Created FMV data', 'success');
      }

      // Create test agency
      const agencyEmail = `nike.${Date.now()}@test.com`;
      log(`\\nCreating agency: ${agencyEmail}`, 'info');

      const { data: agency, error: agencyError } = await window.supabase.auth.admin.createUser({
        email: agencyEmail,
        password: 'testpassword123',
        email_confirm: true,
        user_metadata: {
          first_name: 'Nike',
          last_name: 'Marketing',
          role: 'agency',
        },
      });

      if (agencyError) {
        log(`‚ùå Error: ${agencyError.message}`, 'error');
      } else {
        log(`‚úÖ Created agency: ${agency.user.id}`, 'success');

        // Create agency profile
        await window.supabase.from('agencies').insert({
          id: agency.user.id,
          company_name: 'Nike',
          agency_type: 'brand',
          industry: 'Sports & Apparel',
          company_size: '10000+',
          website: 'https://nike.com',
          logo_url: 'https://logo.clearbit.com/nike.com',
        });
        log('  Created agency profile', 'success');

        // Create match
        if (athlete) {
          const { data: match } = await window.supabase.from('agency_athlete_matches').insert({
            agency_id: agency.user.id,
            athlete_id: athlete.user.id,
            match_score: 85,
            tier: 'gold',
            status: 'active',
            match_reasons: ['Strong social media presence', 'Target demographic alignment'],
          }).select().single();

          if (match) {
            log('  Created athlete-agency match', 'success');
          }
        }
      }

      // Create quiz questions
      log('\\nCreating quiz questions...', 'info');
      const quizQuestions = [
        {
          category: 'nil_basics',
          question: 'What does NIL stand for?',
          options: ['Name, Image, and Likeness', 'National Image League', 'New Income Law', 'None of the above'],
          correct_answer: 0,
          difficulty: 'beginner',
          points: 10,
        },
        {
          category: 'ncaa_rules',
          question: 'Can student-athletes earn money from NIL deals?',
          options: ['Yes, as of July 2021', 'No, it is prohibited', 'Only professionals', 'Only in certain states'],
          correct_answer: 0,
          difficulty: 'beginner',
          points: 10,
        },
      ];

      for (const q of quizQuestions) {
        await window.supabase.from('quiz_questions').insert(q);
      }
      log('‚úÖ Created quiz questions', 'success');

      log('\\n' + '='.repeat(70), 'info');
      log('üéâ NEW DATABASE IS READY!', 'success');
      log('='.repeat(70), 'info');
      log('\\nüìä Test Accounts:', 'info');
      log(`  Athlete: ${athleteEmail} / testpassword123`, 'success');
      log(`  Agency: ${agencyEmail} / testpassword123`, 'success');
      log('\\nüåê Open: http://localhost:3001', 'info');
      log('‚úÖ Everything is migrated and ready to use!', 'success');

      btn.disabled = false;
    };
  </script>
</body>
</html>
