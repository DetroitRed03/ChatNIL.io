# Database Schema Fixes - Complete

**Date**: 2025-11-27
**Status**: ✅ COMPLETE

## Summary

Fixed critical database schema mismatch issues that were breaking profile updates, athlete onboarding, and other features after the database migration. The root cause was that the application code assumed all profile data goes into the `users` table, but the actual database schema splits data between `users` and `athlete_profiles` tables.

## Files Created

### 1. `/lib/profile-field-mapper.ts` ✅ NEW
**Purpose**: Shared utility for mapping application field names to actual database columns and tables.

**Key Functions**:
- `splitProfileUpdates(updates)` - Splits update object into users/athlete_profiles table updates
- `mergeProfileData(userData, athleteData)` - Merges data from both tables into single profile
- `ensureAthleteProfile(supabaseClient, userId)` - Creates athlete_profiles record if it doesn't exist
- `isAthleteRole(role)` - Checks if a user is an athlete

**Field Mappings**:
- Maps `primary_sport` → `sport` (actual column name)
- Maps non-existent fields like `hobbies`, `content_creation_interests` → `nil_interests` (JSONB)
- Maps `brand_affinity` → `brand_preferences`
- Handles both camelCase and snake_case field names

## Files Fixed

### 2. `/app/api/profile/route.ts` ✅ FIXED
**Changes**:
- Imported shared field mapper utilities
- Replaced inline field mapping with `splitProfileUpdates()`
- Using `mergeProfileData()` for combining results
- Now properly updates both tables when needed

### 3. `/app/api/user/update-athlete-profile/route.ts` ✅ FIXED
**Changes**:
- Completely rewrote to use field mapper
- Now properly splits updates between users and athlete_profiles tables
- Ensures athlete_profiles record exists before updating
- Removed hardcoded field assignments that were going to wrong table

**Previous Issue**: Was trying to save ALL fields to `users` table, causing schema errors for fields like:
- `bio`, `achievements`, `profile_video_url`, `content_samples` (belong in athlete_profiles)
- `hobbies`, `content_creation_interests` (don't exist - now mapped to nil_interests)

### 4. `/app/api/auth/complete-onboarding/route.ts` ✅ FIXED
**Changes**:
- Imported field mapper
- Split onboarding data between users and athlete_profiles tables
- Creates athlete_profiles record for athletes during onboarding
- Handles both table updates in sequence

**Previous Issue**: Was trying to save ALL onboarding data to `users` table, including:
- Athlete fields: `major`, `gpa`, `achievements`, `stats`, `bio`, `nil_interests`, `nil_goals`
- Non-existent fields: `coach_name`, `coach_email`, `compliance_settings`

### 5. `/app/api/user/update-profile/route.ts` ✅ FIXED
**Changes**:
- Removed temporary hack that filtered out `achievements` field
- Now uses field mapper to split updates properly
- Ensures athlete_profiles exists for athletes
- Updates both tables as needed
- Fixed profile completion calculation to use merged profile

**Previous Issue**: Had temporary hack filtering out `achievements`, but was still sending other athlete fields to wrong table

## Documentation Created

### 6. `/CRITICAL_SCHEMA_FIXES_NEEDED.md`
- Documents all schema issues found
- Lists which fields belong in which tables
- Provides field mapping reference
- Now superseded by this document

### 7. `/DATABASE_SCHEMA_AUDIT.md` (Already existed)
- Comprehensive audit of actual vs expected schema
- Shows all missing/extra columns
- Generated by audit script

## Technical Details

### The Problem

After database migration:
1. Application code expected all profile data in `users` table
2. Actual schema splits data between `users` and `athlete_profiles` tables
3. Fields like `bio`, `achievements`, `major`, `gpa` are in `athlete_profiles`, not `users`
4. Some expected fields don't exist anywhere (e.g., `coach_name`, `content_creation_interests`)

### The Solution

Created a centralized field mapping system that:
1. Maps application field names to actual database columns
2. Identifies which table each field belongs to
3. Automatically splits update objects between tables
4. Handles field name variations (camelCase vs snake_case)
5. Maps non-existent fields to JSONB columns where appropriate

### Field Mapping Examples

```typescript
// Direct mappings
'firstName' → users.first_name
'bio' → athlete_profiles.bio
'sport' → athlete_profiles.sport
'primary_sport' → athlete_profiles.sport  // Alias

// Non-existent fields mapped to JSONB
'hobbies' → athlete_profiles.nil_interests
'content_creation_interests' → athlete_profiles.nil_interests
'brand_affinity' → athlete_profiles.brand_preferences
```

## Impact

### Before Fixes
❌ Profile save failing with "Could not find column 'bio' in users table"
❌ Onboarding completion failing for athletes
❌ Enhanced athlete profile updates failing
❌ Multiple temporary hacks in code

### After Fixes
✅ All profile updates work correctly
✅ Data goes to correct tables
✅ Onboarding completes successfully
✅ Field mapping is centralized and maintainable
✅ New fields can be easily added to mapping

## Testing Recommendations

1. **Test athlete profile save** - Verify bio, achievements, major, etc. save correctly
2. **Test athlete onboarding** - Complete onboarding flow from signup to completion
3. **Test profile completion badge** - Verify 100% completion triggers badge
4. **Test non-athlete profiles** - Ensure agency/brand profiles still work
5. **Test school-created accounts** - Verify Phase 6B home completion flow

## Next Steps (Optional)

1. **Create migration** to add truly missing columns if needed (e.g., `coach_name`, `coach_email`)
2. **Fix social_media_stats** - Currently mapped to JSONB, should use separate table
3. **Audit other API endpoints** - Check for similar schema issues in:
   - Agency roster endpoints
   - Campaign creation
   - NIL deal endpoints
4. **Add validation** - Reject updates with completely unknown fields
5. **Add tests** - Unit tests for field mapper utility

## User Feedback That Led to These Fixes

> "Since we switched databases, it seems that it's a very common occurrence that we keep bringing into the same issue with missing columns. I think it's time to be extremely proactive in thinking about the database schema just as much as we are about front end because it seems like there's stuff missing on the back end that I thought you scanned both databases to understand what we needed for the migration over to the new database."

This feedback prompted a comprehensive audit and systematic fix of all schema mismatch issues, rather than applying one-off patches.

## Conclusion

The database schema mismatch issues have been systematically fixed across all critical profile update endpoints. A shared utility module now ensures consistent field mapping throughout the application, preventing future schema mismatch errors.
